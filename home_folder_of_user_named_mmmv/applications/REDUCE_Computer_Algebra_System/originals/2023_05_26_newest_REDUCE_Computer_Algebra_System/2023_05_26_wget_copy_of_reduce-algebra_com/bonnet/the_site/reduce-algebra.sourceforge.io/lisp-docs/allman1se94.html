<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Shared Memory Interface (Unix only)</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,html --> 
<meta name="src" content="allman1.tex"> 
<meta name="date" content="2014-05-02 18:10:00"> 
<link rel="stylesheet" type="text/css" href="allman1.css"> 
</head><body 
>
<p align="centre"><img src="https://reduce-algebra.sourceforge.io/lisp-docs/redlogo.png" width=621 height=60 border=0 alt="REDUCE"></p><table cellspacing="5"><tr><td class="clinks"><a 
href="allman1li20.html#allman1se94.html" >Up</a></td><td class="clinks"><a 
href="allman1se95.html" >Next</a></td><td class="clinks"><a 
href="allman1se93.html" >Prev</a></td><td class="clinks"><a 
href="allman1se93.html#tailallman1se93.html" >PrevTail</a></td><td class="clinks"><a 
href="allman1se94.html#tailallman1se94.html">Tail</a></td></tr></table><h3 class="sectionHead"><span class="titlemark">21.5    </span> <a 
 id="x117-23700021.5"></a>Shared Memory Interface (Unix only)</h3>
<!--l. 119--><p class="noindent" >The PSL shared memory interface provides all function for operating with shared memory
regions and semaphores (See e.g. Unix man pages for shmop, shmget, shmctl, semop, semctl,
semget etc.) The definitions of these man pages are used in the paragraph. Using the memory
address map mechanism described below,it is easy to write one&#8217;s own shared memory
application.
<!--l. 127--><p class="noindent" >In the rest of this paragraph we describe a simple model implementation of a &#8217;pipe&#8217; using
shared memory and a semaphore. This code is contained in the file $pu/shmem.sl.
<br 
class="newline" />
<!--l. 136--><p class="noindent" ><div class="minipage"><a 
 id="dx117-237001"></a>
<span 
class="ptmb7t-x-x-120">(shm-open S:pair M:Mode):any                                                                                 </span><span 
class="ptmri7t-x-x-120">expr</span>
<br 
class="newline" /><div class="minipage">If S = 0, a new shared memory area is allocated. Otherwise S is expected
to  be  a  dotted  pair  of  shmid  and  semid  of  an  existing  shared  memory.
Legal modes are <span 
class="ptmb7t-x-x-120">input</span><span 
class="ptmb7t-x-x-120">_create, output</span><span 
class="ptmb7t-x-x-120">_create, input and output</span>. A list
consisting of channelnumber shmid and semid is returned.</div>
</div>
<!--l. 139--><p class="noindent" ><div class="minipage"><a 
 id="dx117-237002"></a>
<span 
class="ptmb7t-x-x-120">(independentdetachshm C:channel): any                                                                  </span><span 
class="ptmri7t-x-x-120">expr</span>
<br 
class="newline" /><div class="minipage">Detaches the shared memory region used by C, closes the channel.
</div></div>
<!--l. 143--><p class="noindent" ><div class="minipage"><a 
 id="dx117-237003"></a>
<span 
class="ptmb7t-x-x-120">(readfromshm C:channel):any                                                                                   </span><span 
class="ptmri7t-x-x-120">expr</span>
<br 
class="newline" /><div class="minipage">Waits until the shared memory region is readable, reads an expression and
resets the mode to writable. Returns the expression.</div>
</div>
<!--l. 147--><p class="noindent" ><div class="minipage"><a 
 id="dx117-237004"></a>
<span 
class="ptmb7t-x-x-120">(writetoshm C:channel E:expression):list                                                                 </span><span 
class="ptmri7t-x-x-120">expr</span>
<br 
class="newline" /><div class="minipage">Waits  until  the  shared  memory  region  is  writeable,  prints  the  expression
using prin2. Returns the value of prin2.</div>
</div>
<!--l. 150--><p class="noindent" >The following C program works together with the PSL part such that it prints the
messages read from shared memory when they are ready for printing. It must be started
with two paramemters, namely the shmid and the semid to synchronize with the PSL
part.

<div class="verbatim" id="verbatim-424">
&#x00A0;<br />#include&#x00A0;&#x003C;stdio.h&#x003E;
&#x00A0;<br />#include&#x00A0;&#x003C;sys/types.h&#x003E;
&#x00A0;<br />#include&#x00A0;&#x003C;sys/ipc.h&#x003E;
&#x00A0;<br />#include&#x00A0;&#x003C;sys/sem.h&#x003E;
&#x00A0;<br />
&#x00A0;<br />struct&#x00A0;sembuf&#x00A0;;
&#x00A0;<br />
&#x00A0;<br />struct&#x00A0;sembuf&#x00A0;sembu;
&#x00A0;<br />struct&#x00A0;sembuf&#x00A0;&#x22C6;sembuptr;
&#x00A0;<br />
&#x00A0;<br />main&#x00A0;(argc,argv)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;int&#x00A0;argc;
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;char&#x00A0;&#x22C6;argv[];
&#x00A0;<br />
&#x00A0;<br />{&#x00A0;int&#x00A0;sema&#x00A0;,&#x00A0;shmemid;
&#x00A0;<br />&#x00A0;&#x00A0;char&#x00A0;&#x22C6;&#x00A0;shmaddress;
&#x00A0;<br />
&#x00A0;<br />&#x00A0;&#x00A0;sembuptr&#x00A0;=&#x00A0;&amp;sembu;
&#x00A0;<br />
&#x00A0;<br />&#x00A0;&#x00A0;sscanf(argv[1],"%d",&amp;shmemid);
&#x00A0;<br />&#x00A0;&#x00A0;sscanf(argv[2],"%d",&amp;sema);
&#x00A0;<br />
&#x00A0;<br />&#x00A0;&#x00A0;/&#x22C6;&#x00A0;open&#x00A0;shared&#x00A0;memory&#x00A0;&#x22C6;/
&#x00A0;<br />
&#x00A0;<br />&#x00A0;printf("the&#x00A0;data&#x00A0;is&#x00A0;:&#x00A0;%d&#x00A0;%d\n",shmemid,sema);
&#x00A0;<br />&#x00A0;&#x00A0;shmaddress&#x00A0;=&#x00A0;shmat(shmemid,0,0);
&#x00A0;<br />
&#x00A0;<br />&#x00A0;&#x00A0;while&#x00A0;(1)
&#x00A0;<br />&#x00A0;&#x00A0;{&#x00A0;waitsema(sema)&#x00A0;;&#x00A0;/&#x22C6;&#x00A0;wait&#x00A0;for&#x00A0;a&#x00A0;0&#x00A0;&#x22C6;/
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;printf("the&#x00A0;message&#x00A0;is&#x00A0;:&#x00A0;%s&#x00A0;\n",shmaddress&#x00A0;+4);
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;setsema&#x00A0;(sema,2)&#x00A0;;&#x00A0;/&#x22C6;&#x00A0;ok,&#x00A0;eaten&#x00A0;&#x22C6;/
&#x00A0;<br />&#x00A0;&#x00A0;}
&#x00A0;<br />}
&#x00A0;<br />
&#x00A0;<br />setsema&#x00A0;(sema,val)
&#x00A0;<br />int&#x00A0;sema,val;
&#x00A0;<br />{&#x00A0;semctl(sema,0,SETVAL,val);&#x00A0;}
&#x00A0;<br />
&#x00A0;<br />waitsema&#x00A0;(sema)
&#x00A0;<br />
&#x00A0;<br />int&#x00A0;sema;
&#x00A0;<br />{

&#x00A0;<br />&#x00A0;&#x00A0;sembu.sem_num&#x00A0;=0;&#x00A0;sembu.sem_op&#x00A0;=&#x00A0;0;&#x00A0;sembu.sem_flg&#x00A0;=0;
&#x00A0;<br />
&#x00A0;<br />&#x00A0;&#x00A0;semop&#x00A0;(sema,&#x00A0;sembuptr&#x00A0;,&#x00A0;1);
&#x00A0;<br />}
</div>
<!--l. 204--><p class="nopar" >

<!--l. 206--><p class="noindent" ><table cellspacing="5"><tr><td class="clinks"><a 
href="allman1li20.html#allman1se94.html" >Up</a></td><td class="clinks"><a 
href="allman1se95.html" >Next</a></td><td class="clinks"><a 
href="allman1se93.html" >Prev</a></td><td class="clinks"><a 
href="allman1se93.html#tailallman1se93.html" >PrevTail</a></td><td class="clinks"><a 
href="allman1se94.html" >Front</a></td></tr></table><a 
 id="tailallman1se94.html"></a>  
</body></html> 
