<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Non-Local Exits</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,html --> 
<meta name="src" content="allman1.tex"> 
<meta name="date" content="2014-05-02 18:10:00"> 
<link rel="stylesheet" type="text/css" href="allman1.css"> 
</head><body 
>
<p align="centre"><img src="http://www.reduce-algebra.com/lisp-docs/redlogo.png" width=621 height=60 border=0 alt="REDUCE"></p><table cellspacing="5"><tr><td class="clinks"><a 
href="allman1li6.html#allman1se24.html" >Up</a></td><td class="clinks"><a 
href="allman1se23.html" >Prev</a></td><td class="clinks"><a 
href="allman1se23.html#tailallman1se23.html" >PrevTail</a></td><td class="clinks"><a 
href="allman1se24.html#tailallman1se24.html">Tail</a></td></tr></table><h3 class="sectionHead"><span class="titlemark">7.4    </span> <a 
 id="x33-850007.4"></a>Non-Local Exits</h3>
<!--l. 1186--><p class="noindent" >The functions catch and throw are very useful for discontinuing a computation. As return
provides for local exit, this pair of functions provide for non-local exit. They should not,
however, be used indiscriminately. The lexical restrictions on their more local counterparts
ensure that the flow of control can be ascertained by looking at a single piece of code.
With catch and throw, control may be passed to and from totally unrelated pieces of
code.
<!--l. 1207--><p class="noindent" ><div class="minipage"><a 
 id="dx33-85001"></a>
<span 
class="ptmb7t-x-x-120">(catch TAG:id [FORM:form]): any                                                </span><span 
class="ptmri7t-x-x-120">Open-Compiled fexpr</span>
<br 
class="newline" /><div class="minipage">Catch  evaluates  TAG  to  establish  a  name  for  this  catcher,  called  the
catch-tag,  and  then  evaluates  the  FORM&#8217;s  in  a  protected  environment.  If
during  this  evaluation  a  throw  occurs  with  a  tag  that  is  the  same  as  the
catch-tag  (as  defined  by  the  function  eq),  catch  immediately  returns  the
result of the form given as the second argument to the throw. If no throw
occurs, the results returned by the last FORM are returned as the result of
the catch. A catch-tag of nil is considered special, it serves to match any
catch-tag specified by throw.</div>
</div>
<!--l. 1216--><p class="noindent" ><div class="minipage"><a 
 id="dx33-85002"></a>
<span 
class="ptmb7t-x-x-120">(throw TAG:id VALUE:any): None Returned                                                          </span><span 
class="ptmri7t-x-x-120">expr</span>
<br 
class="newline" /><div class="minipage">Throw  evaluates  TAG  to  produce  a  catch-tag  and  evaluates  VALUE  to
produce a result value. At this point, an error is signalled if there is no active
catch with the same catch-tag (as determined by the function eq). Otherwise,
control is passed to the most recent such catch, and the results of evaluating
VALUE become the results of the catch.</div></div>
<!--l. 1218--><p class="noindent" >In the process of transferring control to the catch, all intervening constructs are exited. Exiting a
construct that binds variables has the effect of unbinding those variables.
<!--l. 1222--><p class="noindent" >throwsignal* [Initially: nil] global This fluid variable is set to t if the most recent invocation of
Catch was thrown to. throwsignal* is set to nil upon a normal exit from a catch and to t upon a
normal exit from a throw.
<!--l. 1228--><p class="noindent" >throwtag* [Initially: nil] global This fluid variable is set to the catch-tag of the most recent
throw
<!--l. 1232--><p class="noindent" >The catch, throw pair supply a construct which allows for some control over the evaluation of an
expression. Exceptions can be detected during the evaluation of the expression and appropriate
action can be taken. The functions which follow define a simple parser. The parse is done inside
a catch. If there are no errors then the result of the parse is returned. When an error arises the
computation is aborted with a call on throw. An error message is printed prior to aborting the
parse.

<div class="verbatim" id="verbatim-241">
(de&#x00A0;parse&#x00A0;(&#x22C6;buffer&#x22C6;)
&#x00A0;<br />&#x00A0;&#x00A0;(catch&#x00A0;'parse-error&#x00A0;(list&#x00A0;'s&#x00A0;(parse-np)&#x00A0;(parse-vp))))
&#x00A0;<br />
&#x00A0;<br />(de&#x00A0;parse-np&#x00A0;()
&#x00A0;<br />&#x00A0;&#x00A0;(if&#x00A0;(memq&#x00A0;(car&#x00A0;&#x22C6;buffer&#x22C6;)&#x00A0;'(a&#x00A0;an&#x00A0;the))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#8216;(np&#x00A0;(det&#x00A0;,(pop&#x00A0;&#x22C6;buffer&#x22C6;))&#x00A0;(n&#x00A0;,(pop&#x00A0;&#x22C6;buffer&#x22C6;)))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;(parse-error&#x00A0;"Bad&#x00A0;word&#x00A0;in&#x00A0;noun&#x00A0;phrase:&#x00A0;%w%n")))
&#x00A0;<br />
&#x00A0;<br />(de&#x00A0;parse-vp&#x00A0;()
&#x00A0;<br />&#x00A0;&#x00A0;(if&#x00A0;(memq&#x00A0;(car&#x00A0;&#x22C6;buffer&#x22C6;)&#x00A0;'(sings&#x00A0;talks))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#8216;(vp&#x00A0;(v&#x00A0;,(pop&#x00A0;&#x22C6;buffer&#x22C6;)))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;(parse-error&#x00A0;"Not&#x00A0;a&#x00A0;verb:&#x00A0;%w%n")))
&#x00A0;<br />
&#x00A0;<br />
&#x00A0;<br />(de&#x00A0;parse-error&#x00A0;(format-string)
&#x00A0;<br />&#x00A0;&#x00A0;(throw&#x00A0;'parse-error&#x00A0;(printf&#x00A0;format-string&#x00A0;(car&#x00A0;&#x22C6;buffer&#x22C6;))))
</div>
<!--l. 1258--><p class="nopar" >

<div class="verbatim" id="verbatim-242">
1&#x00A0;lisp&#x003E;&#x00A0;(parse&#x00A0;'(the&#x00A0;bird&#x00A0;sings))
&#x00A0;<br />(S&#x00A0;(NP&#x00A0;(DET&#x00A0;THE)&#x00A0;(N&#x00A0;BIRD))&#x00A0;(VP&#x00A0;(V&#x00A0;SINGS)))
&#x00A0;<br />2&#x00A0;lisp&#x003E;&#x00A0;(parse&#x00A0;'(the&#x00A0;bird&#x00A0;eats))
&#x00A0;<br />Not&#x00A0;a&#x00A0;verb:&#x00A0;eats
&#x00A0;<br />nil
&#x00A0;<br />3&#x00A0;lisp&#x003E;&#x00A0;(parse&#x00A0;'(it&#x00A0;is&#x00A0;small))
&#x00A0;<br />Bad&#x00A0;word&#x00A0;in&#x00A0;noun&#x00A0;phrase:&#x00A0;it
&#x00A0;<br />nil
</div>
<!--l. 1268--><p class="nopar" >The following macros are provided to aid in the use of catch and throw with a nil catch-tag, by
examining throwsignal* and throwtag*:
<!--l. 1281--><p class="noindent" ><div class="minipage"><a 
 id="dx33-85003"></a>
<span 
class="ptmb7t-x-x-120">(catch-all HANDLER:function [FORM:form]): any                                            </span><span 
class="ptmri7t-x-x-120">macro</span>
<br 
class="newline" /><div class="minipage">Has  the  same  semantics  as  catch  except  that  all  throws,  independent  of
catch-tag,  will  be  caught.  The  HANDLER  must  be  a  function  of  two
arguments. If a throw occurs, the HANDLER will be called on the catch-tag
and the value passed by the throw. The HANDLER may itself issue a throw,
in which case the catch-all acts as a filter.</div></div>
<!--l. 1287--><p class="noindent" ><div class="minipage"><a 
 id="dx33-85004"></a>
<span 
class="ptmb7t-x-x-120">(unwind-all HANDLER:function [FORM:form]): any                                        </span><span 
class="ptmri7t-x-x-120">macro</span>
<br 
class="newline" /><div class="minipage">This function is very similar to catch-all. However, if no throw occurs the
HANDLER will be called on nil and the value returned.</div></div>
<!--l. 1294--><p class="noindent" ><div class="minipage"><a 
 id="dx33-85005"></a>
<span 
class="ptmb7t-x-x-120">(unwind-protect FORM:form [CLEANUPFORM:form]): any                           </span><span 
class="ptmri7t-x-x-120">macro</span>
<br 
class="newline" /><div class="minipage">The FORM is evaluated and, regardless of how it is exited (a normal return,
throw, or error), the CLEANUPFORMs will be evaluated. One common use
of unwind-protect is to ensure that a file will be closed after processing.</div>
</div>

<div class="verbatim" id="verbatim-243">
&#x00A0;&#x00A0;&#x00A0;&#x00A0;(setq&#x00A0;channel&#x00A0;(open&#x00A0;file&#x00A0;....))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;(unwind-protect&#x00A0;(process-file)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(close&#x00A0;channel))
</div>
<!--l. 1299--><p class="nopar" >This primitive can be used to implement arbitrary kinds of state-binding without fear that an
unusual return (an error or throw), will violate the binding.

<div class="verbatim" id="verbatim-244">
&#x00A0;&#x00A0;&#x00A0;&#x00A0;(defmacro&#x00A0;bind&#x00A0;((name&#x00A0;value)&#x00A0;.&#x00A0;body)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(let&#x00A0;((old-value&#x00A0;(gensym)))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#8216;(let&#x00A0;((,old-value&#x00A0;,name))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(unwind-protect
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(progn&#x00A0;(setq&#x00A0;,name&#x00A0;,value)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;,@body)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(setq&#x00A0;,name&#x00A0;,old-value)))))
</div>
<!--l. 1312--><p class="nopar" >

<div class="verbatim" id="verbatim-245">
&#x00A0;&#x00A0;&#x00A0;&#x00A0;1&#x00A0;lisp&#x003E;&#x00A0;(setq&#x00A0;number&#x00A0;5)
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;5
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;2&#x00A0;lisp&#x003E;&#x00A0;(bind&#x00A0;(number&#x00A0;2)&#x00A0;(print&#x00A0;number)&#x00A0;(/&#x00A0;number&#x00A0;0))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;2
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x22C6;&#x22C6;&#x22C6;&#x22C6;&#x22C6;&#x00A0;Attempt&#x00A0;to&#x00A0;divide&#x00A0;by&#x00A0;zero&#x00A0;in&#x00A0;Quotient
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;3&#x00A0;lisp&#x003E;&#x00A0;number
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;5
</div>
<!--l. 1321--><p class="nopar" >Note: Certain special tags are used in the PSL system, and should not be interfered with
casually:<br 
class="newline" />
<div class="tabular"><table id="TBL-5" class="tabular" 
cellspacing="0" cellpadding="0"  
><colgroup id="TBL-5-1g"><col 
id="TBL-5-1"><col 
id="TBL-5-2"></colgroup><tr  
 style="vertical-align:baseline;" id="TBL-5-1-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-1-1"  
class="td11">$error$                </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-1-2"  
class="td11">Used by error and errorset which are                           </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-2-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-2-1"  
class="td11">            </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-2-2"  
class="td11">implemented in terms of catch and throw,                    </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-3-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-3-1"  
class="td11">            </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-3-2"  
class="td11">(see Chapter 16).                                                           </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-4-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-4-1"  
class="td11">$unwind-protect$</td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-4-2"  
class="td11">A special catch-tag placed to ensure                            </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-5-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-5-1"  
class="td11">            </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-5-2"  
class="td11">that all throws pause at the                                           </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-6-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-6-1"  
class="td11">            </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-6-2"  
class="td11">unwind-protect &#8221;mark&#8221;.                                                </td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-7-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-7-1"  
class="td11">$prog$                 </td><td  style="white-space:nowrap; text-align:left;" id="TBL-5-7-2"  
class="td11">Used to communicate between interpreted progs, gos.</td>
</tr><tr  
 style="vertical-align:baseline;" id="TBL-5-8-"><td  style="white-space:nowrap; text-align:left;" id="TBL-5-8-1"  
class="td11">            </td></tr></table></div>

<table cellspacing="5"><tr><td class="clinks"><a 
href="allman1li6.html#allman1se24.html" >Up</a></td><td class="clinks"><a 
href="allman1se23.html" >Prev</a></td><td class="clinks"><a 
href="allman1se23.html#tailallman1se23.html" >PrevTail</a></td><td class="clinks"><a 
href="allman1se24.html" >Front</a></td></tr></table><a 
 id="tailallman1se24.html"></a>  
</body></html> 
